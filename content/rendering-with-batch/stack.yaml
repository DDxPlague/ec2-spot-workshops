Outputs:
  Subnets:
    Value: '"subnet-53cd991e", "subnet-6104853e", "subnet-2bba3e4d", "subnet-7c3ab95d", "subnet-589a5169", "subnet-a080feae"'
  BucketName:
    Value:
      Ref: bucket43879C71
  BlendFileName:
    Value: blendfile.blend
  RepositoryName:
    Value:
      Ref: repository9F1A3F0B
  LaunchTemplateName:
    Value: RenderingWithBatch
Resources:
  securityGroup32C48086:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RenderingWithBatchStack/securityGroup
      GroupName: RenderingWithBatch
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId: vpc-97cd1dea
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/securityGroup/Resource
  bucket43879C71:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: rendering-with-batch-50aea57d-1829-4ded-b942-202c7f351719
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/bucket/Resource
  repository9F1A3F0B:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: rendering-with-batch
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/repository/Resource
  launchTemplateDEE5742D:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        SecurityGroupIds:
          - Fn::GetAtt:
              - securityGroup32C48086
              - GroupId
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: RenderingWithBatchStack/launchTemplate
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: RenderingWithBatchStack/launchTemplate
        UserData:
          Fn::Base64: |-
            MIME-Version: 1.0
            Content-Type: multipart/mixed; boundary="==MYBOUNDARY=="

            --==MYBOUNDARY==
            Content-Type: text/x-shellscript; charset="us-ascii"

            #!/bin/bash
            echo "ECS_CLUSTER=EcsSpotWorkshop" >> /etc/ecs/ecs.config
            echo "ECS_ENABLE_SPOT_INSTANCE_DRAINING=true" >> /etc/ecs/ecs.config
            echo "ECS_CONTAINER_STOP_TIMEOUT=90s" >> /etc/ecs/ecs.config
            echo "ECS_ENABLE_CONTAINER_METADATA=true" >> /etc/ecs/ecs.config

            --==MYBOUNDARY==--
      LaunchTemplateName: RenderingWithBatch
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/launchTemplate/Resource
  cloud9ec2env53572621:
    Type: AWS::Cloud9::EnvironmentEC2
    Properties:
      InstanceType: t2.micro
      Name: RenderingWithBatch
      SubnetId: subnet-53cd991e
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/cloud9/ec2env/Resource
  cloud9resizeLambdaServiceRole05E60486:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/cloud9/resizeLambda/ServiceRole/Resource
  cloud9resizeLambdaServiceRoleDefaultPolicy78F9CA52:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ec2:DescribeInstances
              - ec2:ModifyVolume
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: cloud9resizeLambdaServiceRoleDefaultPolicy78F9CA52
      Roles:
        - Ref: cloud9resizeLambdaServiceRole05E60486
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/cloud9/resizeLambda/ServiceRole/DefaultPolicy/Resource
  cloud9resizeLambda901AA53D:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        ZipFile: |
          import boto3
          import cfnresponse


          def retrieve_cloud9_instance(env_id):
              print("Retrieving environment's instance...")

              client = boto3.client('ec2')

              instance_data = client.describe_instances(
                  Filters=[
                      {
                          'Name': 'tag:aws:cloud9:environment',
                          'Values': [
                              env_id,
                          ]
                      },
                  ]
              )['Reservations'][0]['Instances'][0]

              return instance_data['InstanceId'], instance_data['BlockDeviceMappings'][0]['Ebs']['VolumeId']


          def resize_volume(volume_id, new_size):
              print('Resizing EBS volume...')

              client = boto3.client('ec2')

              client.modify_volume(
                  VolumeId=volume_id,
                  Size=new_size
              )


          def handler(event, context):
              if event['RequestType'] == 'Create':
                  # Extract context variables
                  c9_env_id = event['ResourceProperties']['cloud9EnvId']
                  ebs_size = int(event['ResourceProperties']['ebsSize'])

                  try:
                      # Retrieve EC2 instance's identifier and its EBS volume's identifier
                      instance_id, volume_id = retrieve_cloud9_instance(c9_env_id)

                      # Resize the EBS volume
                      resize_volume(volume_id, ebs_size)
                  except Exception as e:
                      cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': e.args[0]})
                      return

              cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
      Role:
        Fn::GetAtt:
          - cloud9resizeLambdaServiceRole05E60486
          - Arn
      Handler: index.handler
      Runtime: python3.7
      Timeout: 30
    DependsOn:
      - cloud9resizeLambdaServiceRoleDefaultPolicy78F9CA52
      - cloud9resizeLambdaServiceRole05E60486
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/cloud9/resizeLambda/Resource
  cloud9resizeLambdaCustomResource13CADC97:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - cloud9resizeLambda901AA53D
          - Arn
      cloud9EnvId:
        Ref: cloud9ec2env53572621
      ebsSize: 40
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/cloud9/resizeLambdaCustomResource/Default
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAA/1WPzWrEMAyEn2XvXm+TPeVWGtK9FLqkfQFXUVk3sRVsqSUYv3vzQ2D3NJ+kYQYVuigr/XR4Nn/xCF1/SkABdfpgA71qMZIEQFV/+3fhUVjV5CMHgZkkMrl7y85ZLWkJoZyDECRYni6BZFxMj4s3Ix5un+jGwfAa8rjJKp51ehHokZfrRlkhBJ1aHClapjBt7fuUFQwkXaVTA2Xjf20g79CvAXdjU5dZDcZ9dUan17mVLfnFs3NW1ri5hobtvUWvNFhY+zbKOavrxDfyp7OudHH4idYeg3i2DnW76T/CcBd3ZgEAAA==
    Metadata:
      aws:cdk:path: RenderingWithBatchStack/CDKMetadata/Default

